import{a as W,s as z,u as X,b as Z,c as q,r as s,j as e,F as ee,B as M,d as te,Q as se,A as ae,m as v,M as oe,e as S}from"./index-2WPDJfjq.js";function ne(t){t.values.forEach(o=>o.stop())}function O(t,o){[...o].reverse().forEach(d=>{const l=t.getVariant(d);l&&z(t,l),t.variantChildren&&t.variantChildren.forEach(m=>{O(m,o)})})}function re(t,o){if(Array.isArray(o))return O(t,o);if(typeof o=="string")return O(t,[o]);z(t,o)}function ie(){const t=new Set,o={subscribe(r){return t.add(r),()=>void t.delete(r)},start(r,d){const l=[];return t.forEach(m=>{l.push(W(m,r,{transitionOverride:d}))}),Promise.all(l)},set(r){return t.forEach(d=>{re(d,r)})},stop(){t.forEach(r=>{ne(r)})},mount(){return()=>{o.stop()}}};return o}function le(){const t=X(ie);return Z(t.mount,[]),t}const ce=le,de=({onBackToLogin:t,orgId:o,orgLogoUrl:r})=>{const{register:d}=q(),[l,m]=s.useState(""),[h,k]=s.useState(""),[f,b]=s.useState(""),[g,E]=s.useState(""),[y,C]=s.useState(""),[x,u]=s.useState(""),[N,w]=s.useState(!1),L=async a=>{if(a.preventDefault(),g!==y){u("Passwords do not match.");return}if(!o){u("Organization code is missing.");return}w(!0),u("");const I=await d(l,h,f,g,o);I.success?(M.success("Registration successful! Please log in."),t()):u(I.message||"Registration failed."),w(!1)};return e.jsxs("div",{className:"p-10 bg-white bg-opacity-80 glassEffect flex flex-col shadow-xl border lms-border",style:{width:"440px"},children:[e.jsx("div",{className:"flex flex-col items-center",children:e.jsx("div",{className:"text-xl font-bold mb-6 text-gray-700",children:e.jsx("img",{src:r?"/content"+r:"/defaultOrgLogo.png",alt:"Company Logo",className:"max-h-24 w-auto object-contain p-1"})})}),e.jsx("div",{className:"flex flex-col",children:e.jsx("h2",{className:"text-lg font-bold mb-4 text-gray-700",children:"Sign Up"})}),e.jsxs("form",{onSubmit:L,className:"w-full",children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"block text-gray-700 text-sm font-bold mb-1",htmlFor:"firstName",children:["First Name",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",id:"firstName",value:l,onChange:a=>m(a.target.value),className:"appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline",placeholder:"First Name",required:!0})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"block text-gray-700 text-sm font-bold mb-1",htmlFor:"lastName",children:["Last Name",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",id:"lastName",value:h,onChange:a=>k(a.target.value),className:"appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline",placeholder:"Last Name",required:!0})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"block text-gray-700 text-sm font-bold mb-1",htmlFor:"email",children:["Email",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"email",id:"email",value:f,onChange:a=>b(a.target.value),className:"appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline",placeholder:"Email",required:!0})]}),e.jsxs("div",{className:"mb-4 relative",children:[e.jsxs("label",{className:"block text-gray-700 text-sm font-bold mb-1",htmlFor:"password",children:["Password",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"password",id:"password",value:g,onChange:a=>E(a.target.value),className:"appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-2 leading-tight focus:outline-none focus:shadow-outline",placeholder:"Password",required:!0})]}),e.jsxs("div",{className:"mb-4 relative",children:[e.jsxs("label",{className:"block text-gray-700 text-sm font-bold mb-1",htmlFor:"confirmPassword",children:["Confirm Password",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"password",id:"confirmPassword",value:y,onChange:a=>C(a.target.value),className:"appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-2 leading-tight focus:outline-none focus:shadow-outline",placeholder:"Confirm Password",required:!0})]}),x&&e.jsx("div",{className:"mb-4 text-red-500 text-sm",children:x}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("button",{type:"button",onClick:t,className:"lms-button px-4 py-2 text-xs",children:"Back to Login"}),e.jsx("button",{type:"submit",className:"lms-button px-4 py-2 text-xs flex items-center",disabled:N,children:N?e.jsxs(e.Fragment,{children:[e.jsx(ee,{className:"animate-spin mr-2"})," Signing Up..."]}):"Sign Up"})]})]})]})},ge=()=>{const[t,o]=s.useState(""),[r,d]=s.useState(""),[l,m]=s.useState(""),[h,k]=s.useState(!1),[f,b]=s.useState("login"),[g,E]=s.useState(!0),[y,C]=s.useState(!1),x=te(),u=ce(),[N,w]=s.useState(0),{login:L,user:a}=q(),P=(()=>{const n=window.location.hostname.split(".");return n.length>1?n[0]:null})(),[D,F]=s.useState(!1),[R,$]=s.useState(!1),[A,B]=s.useState(null),[T,K]=s.useState(!1);s.useEffect(()=>{(async()=>{if(P)try{const n=await S.get(`https://knowvara.com/api/api/orgs/code/${P}`);if(n.data){const c=n.data;document.documentElement.style.setProperty("--theme-color1",c.theme_color1),document.documentElement.style.setProperty("--theme-color2",c.theme_color2),console.log("Got org id: "+c.id),w(c.id),B(c.companyLogoUrl),console.log("Got org data self register: "+c.selfRegister),C(c.selfRegister)}}catch(n){console.error("Failed to fetch organization details:",n),M.error("Invalid organization code. Using default settings.")}E(!1)})()},[P]),s.useEffect(()=>{g||(console.log("Initializing login animation to visible"),u.start("visible"))},[u,g]),s.useEffect(()=>{(async()=>{if(a!=null&&a.Id){try{await G(Number(a.Id))}catch(n){console.error("Error logging login action:",n)}console.log("Looking up subscription for: "+a.OrgID);try{const n=sessionStorage.getItem("token");if(!n)throw new Error("No authentication token found.");const j=(await S.get("https://knowvara.com/api/api/orgs/subscription",{headers:{Authorization:`Bearer ${n}`}})).data,{subscription_plan:p,trial_end:U}=j,J=new Date,V=U?new Date(U):null;p.toLowerCase()==="free"&&V&&V<J?a.Admin==="y"?F(!0):$(!0):(K(!0),console.log("Setting shouldNavigate to true"))}catch(n){console.error("Error fetching subscription data:",n),M.error("Failed to fetch subscription data.")}}})()},[a,x,u]);const _=async i=>{i.preventDefault(),h?localStorage.setItem("keepLoggedIn","true"):localStorage.removeItem("keepLoggedIn"),await L(t,r)||m("Incorrect username or password")},G=async i=>{var j;const n=sessionStorage.getItem("token");if(!n){console.error("No token found, user is not authenticated.");return}const c={userId:i,type:"login"};try{await S.post("https://knowvara.com/api/api/actions/log",c,{headers:{Authorization:`Bearer ${n}`}}),console.log("Login action logged successfully")}catch(p){S.isAxiosError(p)?console.error("Error logging login action:",((j=p.response)==null?void 0:j.data)||p.message):console.error("Error logging login action:",p)}},H=()=>{console.log("Navigating back to login view"),b("login")},Q={hidden:{opacity:0,y:-150},visible:{opacity:1,y:0},exit:{opacity:0,y:-150}},Y={hidden:{opacity:0,y:100},visible:{opacity:1,y:0},exit:{opacity:0,y:100}};return g?e.jsxs("div",{className:"flex items-center justify-center min-h-screen",children:[e.jsx("div",{className:"loader",children:"Loading..."})," "]}):e.jsxs("div",{className:"flex items-center justify-center min-h-screen p-8 bg-gray-100",children:[e.jsx(se,{})," ",e.jsx(ae,{mode:"wait",onExitComplete:()=>{T&&x("/student")},children:f==="signup"?e.jsx(v.div,{variants:Y,initial:"hidden",animate:"visible",exit:"exit",transition:{duration:.5},className:"",style:{width:"440px"},children:e.jsx(de,{orgId:N,onBackToLogin:H,orgLogoUrl:A})},"signup"):R?e.jsx(v.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},className:"p-6 bg-red-100 border border-red-400 text-red-700 rounded mb-4 w-full max-w-md",children:e.jsx("p",{children:"The account you are trying to log in to is no longer active."})},"inactive-message"):!T&&e.jsxs(v.div,{variants:Q,initial:"hidden",animate:"visible",exit:"exit",transition:{duration:.5},className:"p-10 bg-white bg-opacity-80 glassEffect flex flex-col shadow-xl border lms-border",style:{width:"440px"},children:[e.jsx("div",{className:"flex flex-col items-center",children:e.jsx("div",{className:"text-xl font-bold mb-6 text-gray-700",children:e.jsx("img",{src:A?"/content"+A:"/defaultOrgLogo.png",alt:"Company Logo",className:"max-h-24 w-auto object-contain p-1"})})}),e.jsx("div",{className:"flex flex-col",children:e.jsx("h2",{className:"text-lg font-bold mb-4 text-gray-700",children:"Sign in"})}),e.jsxs("form",{onSubmit:_,className:"w-full",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 text-sm font-bold mb-1",htmlFor:"email",children:"Email"}),e.jsx("input",{type:"email",id:"email",value:t,onChange:i=>o(i.target.value),className:"appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline",placeholder:"Email",required:!0})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"block text-gray-700 text-sm font-bold mb-1",htmlFor:"password",children:"Password"}),e.jsx("input",{type:"password",id:"password",value:r,onChange:i=>d(i.target.value),className:"appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline",placeholder:"Password",required:!0}),l&&e.jsx("p",{className:"text-red-500 text-xs italic",children:l})]}),e.jsx("div",{className:"mb-4",children:e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",checked:h,onChange:i=>k(i.target.checked),className:"mr-2"}),e.jsx("span",{className:"text-gray-600",children:"Keep me logged in"})]})}),e.jsx("div",{className:"flex items-center justify-end mb-2",children:e.jsx(v.button,{whileHover:{scale:1.05},whileTap:{scale:.95},className:"lms-button px-4 py-2 text-xs",type:"submit",children:"Sign In"})})]}),y&&e.jsx("div",{className:"text-center mt-4",children:e.jsx("button",{onClick:()=>b("signup"),className:"text-blue-500 hover:text-blue-700 text-sm underline",children:"New User? Sign up here"})})]},"login")}),D&&e.jsxs(oe,{title:"Free Trial Expired",onClose:()=>F(!1),onConfirm:()=>{F(!1),x("/pick-plan")},confirmText:"Upgrade Plan",children:[e.jsx("p",{children:"Your free trial has expired, but there's great news. KnowVara offers the most affordable LMS plans available."}),e.jsx("p",{children:'Click "Upgrade Plan" to continue using KnowVara.'})]})]})};export{ge as default};
