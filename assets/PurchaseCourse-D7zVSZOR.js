import{ab as D,ac as q,r as l,j as e,ad as U,f as c,B as t}from"./index-BSiKmnSf.js";const H=({courseId:h,orgId:i,amount:d,onSuccess:I,onFailure:u,isBundle:m=!1})=>{const v=D(),N=q(),[w,C]=l.useState(!1),[S,a]=l.useState(null),[f,z]=l.useState(""),[y,T]=l.useState(d),[A,j]=l.useState(null),[M,P]=l.useState(!1);l.useEffect(()=>{(async()=>{try{const s=sessionStorage.getItem("token");if(!s)return;(await c.get(`https://knowvara.com/api/api/payments/${i}/coupons/available`,{headers:{Authorization:`Bearer ${s}`}})).data.length>0&&P(!0)}catch(s){console.error("Error fetching available coupons:",s),P(!1)}})()},[i]);const _=async()=>{try{const o=sessionStorage.getItem("token");if(!o){a("User is not authenticated."),t.error("User is not authenticated.");return}const s=await c.post("https://knowvara.com/api/api/payments/coupons/validate",{courseId:h,orgId:i,couponCode:f,amount:d},{headers:{Authorization:`Bearer ${o}`}});s.data.valid?(T(d-d*s.data.percent_off/100),j(f),t.success(`Coupon applied! ${s.data.percent_off}% off.`)):(a("Invalid or expired coupon code."),t.error("Invalid or expired coupon code."),j(null))}catch(o){console.error("Error validating coupon:",o),t.error("Failed to validate coupon."),j(null)}},R=async o=>{var s,$;if(o.preventDefault(),!v||!N){console.log("Stripe has not loaded yet.");return}if(y<=0){a("Invalid payment amount."),t.error("Invalid payment amount.");return}C(!0),a(null);try{const r=sessionStorage.getItem("token");if(!r){a("User is not authenticated."),t.error("User is not authenticated."),C(!1),u();return}let n,x;m?(x=`https://knowvara.com/api/api/bundles/${i}/${h}/payment/create`,n=await c.post(x,{couponCode:f},{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}})):(x="https://knowvara.com/api/api/orgs/payment/create",n=await c.post(x,{courseId:h,amount:d,orgId:i,couponCode:f},{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}}));const{clientSecret:B,paymentIntentId:k}=n.data;if(!B||!k)throw new Error("Failed to create PaymentIntent.");const{paymentIntent:E,error:b}=await v.confirmCardPayment(B,{payment_method:{card:N.getElement(U)}});if(b)console.log(b.message||"Payment failed."),a(b.message||"Payment failed."),t.error(b.message||"Payment failed."),u();else if(E)if(E.status==="requires_capture"){let p,g;m?(g=`https://knowvara.com/api/api/bundles/${i}/${h}/enroll-and-capture`,p=await c.post(g,{paymentIntentId:k},{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}})):(g="https://knowvara.com/api/api/orgs/enroll-and-capture",p=await c.post(g,{paymentIntentId:k},{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}})),p.data.message==="Enrollment successful and payment captured."||p.data.message==="Bundle enrollment successful and payment captured."?(t.success(m?"Successfully enrolled in the bundle!":"Successfully enrolled in the course!"),I()):(a(p.data.message||"Enrollment failed."),t.error(p.data.message||"Enrollment failed."),u())}else console.log("Unexpected payment status:",E.status),a("Unexpected payment status."),t.error("Unexpected payment status."),u()}catch(r){if(console.error("Payment error:",r),c.isAxiosError(r)){const n=($=(s=r.response)==null?void 0:s.data)==null?void 0:$.message;n?(a(n),t.error(n)):(a("Error processing payment."),t.error("Error processing payment."))}else a("An unexpected error occurred."),t.error("An unexpected error occurred.");u()}finally{C(!1)}};return e.jsxs("form",{onSubmit:R,className:"w-full rounded border p-4",children:[S&&e.jsx("div",{className:"mb-2 text-red-600",children:S}),M&&e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 text-sm font-bold mb-2",children:"Coupon Code (Optional)"}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"text",value:f,onChange:o=>z(o.target.value),placeholder:"Enter coupon code",className:"flex-1 p-2 border rounded-l-md focus:outline-none"}),e.jsx("button",{type:"button",onClick:_,className:"px-4 py-2 bg-blue-500 text-white rounded-r-md",children:"Apply"})]}),A&&e.jsxs("p",{className:"text-green-600 mt-2 font-semibold ml-1",children:["Code Applied: ",A]})]}),e.jsxs("div",{className:"mb-8 mt-8",children:[e.jsx("label",{className:"block text-gray-700 text-sm font-bold mb-2",children:"Card Details"}),e.jsx(U,{options:{hidePostalCode:!0},className:"border rounded-lg p-4"})]}),e.jsxs("p",{className:"mb-4 text-xl font-bold",children:["Total: $",y.toFixed(2)]}),e.jsx("button",{type:"submit",disabled:!v||w,className:`w-full py-2 px-4 rounded-md flex items-center justify-center ${w?"bg-blue-300 cursor-not-allowed":"bg-blue-500 hover:bg-blue-600"} text-white`,"aria-label":m?"Purchase Bundle":"Purchase Course",children:w?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{className:"animate-spin h-5 w-5 mr-3 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8v8H4z"})]}),"Processing..."]}):m?`Buy Bundle for $${y}`:`Buy Now for $${y}`})]})};export{H as P};
