import{a as ae,s as D,u as oe,b as ne,c as K,r as s,j as e,F as re,B as ie,d as le,e as ce,A as de,m as L,M as ue,f as b}from"./index-BSiKmnSf.js";function me(t){t.values.forEach(n=>n.stop())}function R(t,n){[...n].reverse().forEach(m=>{const c=t.getVariant(m);c&&D(t,c),t.variantChildren&&t.variantChildren.forEach(d=>{R(d,n)})})}function ge(t,n){if(Array.isArray(n))return R(t,n);if(typeof n=="string")return R(t,[n]);D(t,n)}function pe(){const t=new Set,n={subscribe(i){return t.add(i),()=>void t.delete(i)},start(i,m){const c=[];return t.forEach(d=>{c.push(ae(d,i,{transitionOverride:m}))}),Promise.all(c)},set(i){return t.forEach(m=>{ge(m,i)})},stop(){t.forEach(i=>{me(i)})},mount(){return()=>{n.stop()}}};return n}function he(){const t=oe(pe);return ne(t.mount,[]),t}const xe=he,fe=({onBackToLogin:t,orgId:n,orgLogoUrl:i})=>{const{register:m}=K(),[c,d]=s.useState(""),[w,P]=s.useState(""),[v,S]=s.useState(""),[g,T]=s.useState(""),[k,F]=s.useState(""),[y,p]=s.useState(""),[E,C]=s.useState(!1),I=async o=>{if(o.preventDefault(),g!==k){p("Passwords do not match.");return}if(!n){p("Organization code is missing.");return}C(!0),p("");const N=await m(c,w,v,g,n);N.success?(ie.success("Registration successful! Please log in."),t()):p(N.message||"Registration failed."),C(!1)};return e.jsxs("div",{className:"p-10 bg-white bg-opacity-80 glassEffect flex flex-col shadow-xl border lms-border",style:{width:"440px"},children:[e.jsx("div",{className:"flex flex-col items-center",children:e.jsx("div",{className:"text-xl font-bold mb-6 text-gray-700",children:e.jsx("img",{src:i?"/content"+i:"/defaultOrgLogo.png",alt:"Company Logo",className:"max-h-24 w-auto object-contain p-1"})})}),e.jsx("div",{className:"flex flex-col",children:e.jsx("h2",{className:"text-lg font-bold mb-4 text-gray-700",children:"Sign Up"})}),e.jsxs("form",{onSubmit:I,className:"w-full",children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"block text-gray-700 text-sm font-bold mb-1",htmlFor:"firstName",children:["First Name",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",id:"firstName",value:c,onChange:o=>d(o.target.value),className:"appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline",placeholder:"First Name",required:!0})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"block text-gray-700 text-sm font-bold mb-1",htmlFor:"lastName",children:["Last Name",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",id:"lastName",value:w,onChange:o=>P(o.target.value),className:"appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline",placeholder:"Last Name",required:!0})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"block text-gray-700 text-sm font-bold mb-1",htmlFor:"email",children:["Email",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"email",id:"email",value:v,onChange:o=>S(o.target.value),className:"appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline",placeholder:"Email",required:!0})]}),e.jsxs("div",{className:"mb-4 relative",children:[e.jsxs("label",{className:"block text-gray-700 text-sm font-bold mb-1",htmlFor:"password",children:["Password",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"password",id:"password",value:g,onChange:o=>T(o.target.value),className:"appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-2 leading-tight focus:outline-none focus:shadow-outline",placeholder:"Password",required:!0})]}),e.jsxs("div",{className:"mb-4 relative",children:[e.jsxs("label",{className:"block text-gray-700 text-sm font-bold mb-1",htmlFor:"confirmPassword",children:["Confirm Password",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"password",id:"confirmPassword",value:k,onChange:o=>F(o.target.value),className:"appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-2 leading-tight focus:outline-none focus:shadow-outline",placeholder:"Confirm Password",required:!0})]}),y&&e.jsx("div",{className:"mb-4 text-red-500 text-sm",children:y}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("button",{type:"button",onClick:t,className:"lms-button px-4 py-2 text-xs",children:"Back to Login"}),e.jsx("button",{type:"submit",className:"lms-button px-4 py-2 text-xs flex items-center",disabled:E,children:E?e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"animate-spin mr-2"})," Signing Up..."]}):"Sign Up"})]})]})]})},we=()=>{const[t,n]=s.useState(""),[i,m]=s.useState(""),[c,d]=s.useState(""),[w,P]=s.useState(!1),[v,S]=s.useState("login"),[g,T]=s.useState(!0),[k,F]=s.useState(!1),y=le(),p=xe(),[E,C]=s.useState(0),{login:I,user:o,loginWithTokens:N}=K(),V=()=>{const r=window.location.hostname.split(".");return r.length>1?r[0]:null},$=V(),[_,A]=s.useState(!1),[H,W]=s.useState(!1),[M,Y]=s.useState(null),[q,z]=s.useState(!1),[G]=ce(),U=G.get("redirectToken");s.useEffect(()=>{(async()=>{if($)try{const r=await b.get(`https://knowvara.com/api/api/orgs/code/${$}`);if(r.data){const a=r.data;document.documentElement.style.setProperty("--theme-color1",a.theme_color1),document.documentElement.style.setProperty("--theme-color2",a.theme_color2),C(a.id),Y(a.companyLogoUrl),F(a.selfRegister)}}catch(r){console.error("Failed to fetch organization details:",r)}T(!1)})()},[$]),s.useEffect(()=>{(async()=>{if(U)try{const r=await b.post("https://knowvara.com/api/api/auth/redirect-token/consume",{redirectToken:U}),{accessToken:a,refreshToken:h,user:u}=r.data;N(a,h,u);const x=new URLSearchParams(window.location.search);x.delete("redirectToken");const f=window.location.pathname+(x.toString()?`?${x.toString()}`:"");window.history.replaceState({},"",f),z(!0)}catch(r){console.error("Failed to consume redirect token:",r),d("Failed to authenticate. Please try logging in again.")}})()},[U,N]),s.useEffect(()=>{g||p.start("visible")},[p,g]),s.useEffect(()=>{(async()=>{if(o!=null&&o.Id){try{await Q(Number(o.Id))}catch(a){console.error("Error logging login action:",a)}if(V()!==o.Subdomain)try{const a=sessionStorage.getItem("token");if(!a)throw new Error("No authentication token found.");const h=await b.post("https://knowvara.com/api/api/auth/redirect-token",{},{headers:{Authorization:`Bearer ${a}`}}),{redirectToken:u}=h.data,x=o.Subdomain,f=window.location.protocol,O=window.location.port?`:${window.location.port}`:"";let j;{const B=window.location.hostname.split(".");B.shift();const se=B.join(".");j=`${x}.${se}${O}`}window.location.href=`${f}//${j}/login?redirectToken=${u}`}catch(a){console.error("Error handling subdomain redirect:",a),d("Failed to redirect to the correct subdomain.")}else try{const a=sessionStorage.getItem("token");if(!a)throw new Error("No authentication token found.");const u=(await b.get("https://knowvara.com/api/api/orgs/subscription",{headers:{Authorization:`Bearer ${a}`}})).data,{subscription_plan:x,trial_end:f}=u,O=new Date,j=f?new Date(f):null;x.toLowerCase()==="free"&&j&&j<O?o.Admin==="y"?A(!0):W(!0):z(!0)}catch(a){console.error("Error fetching subscription data:",a),d("Failed to fetch subscription data.")}}})()},[o]);const J=async l=>{l.preventDefault(),w?localStorage.setItem("keepLoggedIn","true"):localStorage.removeItem("keepLoggedIn"),await I(t,i)||d("Incorrect username or password")},Q=async l=>{var h;const r=sessionStorage.getItem("token");if(!r){console.error("No token found, user is not authenticated.");return}const a={userId:l,type:"login"};try{await b.post("https://knowvara.com/api/api/actions/log",a,{headers:{Authorization:`Bearer ${r}`}}),console.log("Login action logged successfully")}catch(u){b.isAxiosError(u)?console.error("Error logging login action:",((h=u.response)==null?void 0:h.data)||u.message):console.error("Error logging login action:",u)}},X=()=>{console.log("Navigating back to login view"),S("login")},Z={hidden:{opacity:0,y:-150},visible:{opacity:1,y:0},exit:{opacity:0,y:-150}},ee={hidden:{opacity:0,y:100},visible:{opacity:1,y:0},exit:{opacity:0,y:100}};return g?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx("div",{className:"",children:"Loading..."})}):e.jsxs("div",{className:"flex items-center justify-center min-h-screen p-8 bg-gray-100",children:[e.jsx(de,{mode:"wait",onExitComplete:()=>{q&&y("/student")},children:v==="signup"?e.jsx(L.div,{variants:ee,initial:"hidden",animate:"visible",exit:"exit",transition:{duration:.5},className:"",style:{width:"440px"},children:e.jsx(fe,{orgId:E,onBackToLogin:X,orgLogoUrl:M})},"signup"):H?e.jsx(L.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},className:"p-6 bg-red-100 border border-red-400 text-red-700 rounded mb-4 w-full max-w-md",children:e.jsx("p",{children:"The account you are trying to log in to is no longer active."})},"inactive-message"):!q&&e.jsxs(L.div,{variants:Z,initial:"hidden",animate:"visible",exit:"exit",transition:{duration:.5},className:"p-10 bg-white bg-opacity-80 glassEffect flex flex-col shadow-xl border lms-border",style:{width:"440px"},children:[e.jsx("div",{className:"flex flex-col items-center",children:e.jsx("div",{className:"text-xl font-bold mb-6 text-gray-700",children:e.jsx("img",{src:M?"/content"+M:"/defaultOrgLogo.png",alt:"Company Logo",className:"max-h-24 w-auto object-contain p-1"})})}),e.jsx("div",{className:"flex flex-col",children:e.jsx("h2",{className:"text-lg font-bold mb-4 text-gray-700",children:"Sign in"})}),e.jsxs("form",{onSubmit:J,className:"w-full",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 text-sm font-bold mb-1",htmlFor:"email",children:"Email"}),e.jsx("input",{type:"email",id:"email",value:t,onChange:l=>n(l.target.value),className:"appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline",placeholder:"Email",required:!0})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"block text-gray-700 text-sm font-bold mb-1",htmlFor:"password",children:"Password"}),e.jsx("input",{type:"password",id:"password",value:i,onChange:l=>m(l.target.value),className:"appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline",placeholder:"Password",required:!0}),c&&e.jsx("p",{className:"text-red-500 text-xs italic",children:c})]}),e.jsx("div",{className:"mb-4",children:e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",checked:w,onChange:l=>P(l.target.checked),className:"mr-2"}),e.jsx("span",{className:"text-gray-600",children:"Keep me logged in"})]})}),e.jsx("div",{className:"flex items-center justify-end mb-2",children:e.jsx(L.button,{whileHover:{scale:1.05},whileTap:{scale:.95},className:"lms-button px-4 py-2 text-xs",type:"submit",children:"Sign In"})})]}),k&&e.jsx("div",{className:"text-center mt-4",children:e.jsx("button",{onClick:()=>S("signup"),className:"text-blue-500 hover:text-blue-700 text-sm underline",children:"New User? Sign up here"})})]},"login")}),_&&e.jsxs(ue,{title:"Free Trial Expired",onClose:()=>A(!1),onConfirm:()=>{A(!1),y("/pick-plan")},confirmText:"Upgrade Plan",children:[e.jsx("p",{children:"Your free trial has expired, but there's great news. KnowVara offers the most affordable LMS plans available."}),e.jsx("p",{children:'Click "Upgrade Plan" to continue using KnowVara.'})]})]})};export{we as default};
