import{a as ae,s as D,u as re,b as ne,c as K,r as s,j as e,F as ie,B as le,d as ce,e as de,A as ue,m as j,M as me,f as w}from"./index-DiVl5c6T.js";function ge(t){t.values.forEach(r=>r.stop())}function V(t,r){[...r].reverse().forEach(p=>{const d=t.getVariant(p);d&&D(t,d),t.variantChildren&&t.variantChildren.forEach(g=>{V(g,r)})})}function pe(t,r){if(Array.isArray(r))return V(t,r);if(typeof r=="string")return V(t,[r]);D(t,r)}function he(){const t=new Set,r={subscribe(l){return t.add(l),()=>void t.delete(l)},start(l,p){const d=[];return t.forEach(g=>{d.push(ae(g,l,{transitionOverride:p}))}),Promise.all(d)},set(l){return t.forEach(p=>{pe(p,l)})},stop(){t.forEach(l=>{ge(l)})},mount(){return()=>{r.stop()}}};return r}function xe(){const t=re(he);return ne(t.mount,[]),t}const fe=xe,be=({onBackToLogin:t,orgId:r,orgLogoUrl:l})=>{const{register:p}=K(),[d,g]=s.useState(""),[v,F]=s.useState(""),[L,E]=s.useState(""),[x,T]=s.useState(""),[I,$]=s.useState(""),[h,f]=s.useState(""),[P,C]=s.useState(!1),A=async o=>{if(o.preventDefault(),x!==I){f("Passwords do not match.");return}if(!r){f("Organization code is missing.");return}C(!0),f("");const b=await p(d,v,L,x,r);b.success?(le.success("Registration successful! Please log in."),t()):f(b.message||"Registration failed."),C(!1)};return e.jsxs("div",{className:"p-8 md:p-16 bg-white bg-opacity-90 rounded-xl shadow-2xl flex flex-col",style:{maxWidth:"480px"},children:[e.jsx("div",{className:"flex flex-col items-center",children:e.jsx("div",{className:"text-xl font-bold mb-6 text-gray-700",children:e.jsx("img",{src:l?"/content"+l:"/defaultOrgLogo.png",alt:"Company Logo",className:"max-h-24 w-auto object-contain p-1"})})}),e.jsx("div",{className:"flex flex-col",children:e.jsx("h2",{className:"text-lg font-bold mb-4 text-gray-700",children:"Sign Up"})}),e.jsxs("form",{onSubmit:A,className:"w-full",children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"block text-gray-700 text-sm font-bold mb-1",htmlFor:"firstName",children:["First Name",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",id:"firstName",value:d,onChange:o=>g(o.target.value),className:"appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline",placeholder:"First Name",required:!0})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"block text-gray-700 text-sm font-bold mb-1",htmlFor:"lastName",children:["Last Name",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",id:"lastName",value:v,onChange:o=>F(o.target.value),className:"appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline",placeholder:"Last Name",required:!0})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"block text-gray-700 text-sm font-bold mb-1",htmlFor:"email",children:["Email",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"email",id:"email",value:L,onChange:o=>E(o.target.value),className:"appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline",placeholder:"Email",required:!0})]}),e.jsxs("div",{className:"mb-4 relative",children:[e.jsxs("label",{className:"block text-gray-700 text-sm font-bold mb-1",htmlFor:"password",children:["Password",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"password",id:"password",value:x,onChange:o=>T(o.target.value),className:"appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-2 leading-tight focus:outline-none focus:shadow-outline",placeholder:"Password",required:!0})]}),e.jsxs("div",{className:"mb-4 relative",children:[e.jsxs("label",{className:"block text-gray-700 text-sm font-bold mb-1",htmlFor:"confirmPassword",children:["Confirm Password",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"password",id:"confirmPassword",value:I,onChange:o=>$(o.target.value),className:"appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-2 leading-tight focus:outline-none focus:shadow-outline",placeholder:"Confirm Password",required:!0})]}),h&&e.jsx("div",{className:"mb-4 text-red-500 text-sm",children:h}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("button",{type:"button",onClick:t,className:"lms-button px-4 py-2 text-xs",children:"Back to Login"}),e.jsx("button",{type:"submit",className:"lms-button px-4 py-2 text-xs flex items-center",disabled:P,children:P?e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"animate-spin mr-2"})," Signing Up..."]}):"Sign Up"})]})]})]})},we=()=>{const[t,r]=s.useState(""),[l,p]=s.useState(""),[d,g]=s.useState(""),[v,F]=s.useState(!1),[L,E]=s.useState("login"),[x,T]=s.useState(!0),[I,$]=s.useState(!1),h=ce(),f=fe(),[P,C]=s.useState(0),{login:A,user:o,loginWithTokens:b}=K(),q=()=>{const n=window.location.hostname.split(".");return n.length>1?n[0]:null},M=q(),[_,O]=s.useState(!1),[W,H]=s.useState(!1),[R,J]=s.useState(null),[z,Y]=s.useState(!1),[G]=de(),k=G.get("redirectToken");s.useEffect(()=>{(async()=>{if(M)try{const n=await w.get(`https://knowvara.com/api/api/orgs/code/${M}`);if(n.data){const i=n.data;document.documentElement.style.setProperty("--theme-color1",i.theme_color1),document.documentElement.style.setProperty("--theme-color2",i.theme_color2),C(i.id),J(i.companyLogoUrl),$(i.selfRegister),i.OrgName?document.title=`${i.OrgName} - Learning Management System`:document.title="Learning Management System"}}catch(n){console.error("Failed to fetch organization details:",n)}console.log("About to set loading to false. Redirect Token: "+k),k||T(!1)})()},[M,k]),s.useEffect(()=>{(async()=>{if(k){console.log("===Just found the redirect token");try{const n=await w.post("https://knowvara.com/api/api/auth/redirect-token/consume",{redirectToken:k}),{accessToken:i,refreshToken:a,user:u}=n.data;b(i,a,u);const m=new URLSearchParams(window.location.search),y=m.get("fromPickPlan");m.delete("redirectToken"),m.delete("fromPickPlan");const N=window.location.pathname+(m.toString()?`?${m.toString()}`:"");window.history.replaceState({},"",N),y==="true"&&window.sessionStorage.setItem("showWelcomeModal","true"),console.log("=== about to navigate with the redirect token"),h("/student")}catch(n){console.error("Failed to consume redirect token:",n),g("Failed to authenticate. Please try logging in again.")}}})()},[k,b,h]),s.useEffect(()=>{(async()=>{if(localStorage.getItem("keepLoggedIn")==="true"){const i=localStorage.getItem("refreshToken");if(i)try{const a=await w.post("https://knowvara.com/api/api/auth/refresh-token",{refreshToken:i}),{accessToken:u,refreshToken:m,user:y}=a.data;b(u,m,y),h("/student")}catch(a){console.error("Failed to auto-login with refresh token:",a),localStorage.removeItem("refreshToken"),localStorage.removeItem("keepLoggedIn")}}T(!1)})()},[b,h]),s.useEffect(()=>{x||f.start("visible")},[f,x]),s.useEffect(()=>{(async()=>{const n=sessionStorage.getItem("token");if(o!=null&&o.Id&&n){console.log("=== got a user for some reason");try{await X(Number(o.Id))}catch(a){console.error("Error logging login action:",a)}if(q()!==o.Subdomain)try{const a=sessionStorage.getItem("token");if(!a)throw new Error("No authentication token found.");const u=await w.post("https://knowvara.com/api/api/auth/redirect-token",{},{headers:{Authorization:`Bearer ${a}`}}),{redirectToken:m}=u.data,y=o.Subdomain,N=window.location.protocol,U=window.location.port?`:${window.location.port}`:"";let S;{const B=window.location.hostname.split(".");B.shift();const oe=B.join(".");S=`${y}.${oe}${U}`}window.location.href=`${N}//${S}/login?redirectToken=${m}`}catch(a){console.error("Error handling subdomain redirect:",a),g("Failed to redirect to the correct subdomain.")}else try{const a=sessionStorage.getItem("token");if(!a)throw new Error("No authentication token found.");const m=(await w.get("https://knowvara.com/api/api/orgs/subscription",{headers:{Authorization:`Bearer ${a}`}})).data,{subscription_plan:y,trial_end:N}=m,U=new Date,S=N?new Date(N):null;y.toLowerCase()==="free"&&S&&S<U?o.Admin==="y"?O(!0):H(!0):Y(!0)}catch(a){console.error("Error fetching subscription data:",a),g("Failed to fetch subscription data.")}}})()},[o]);const Q=async c=>{if(c.preventDefault(),v?localStorage.setItem("keepLoggedIn","true"):localStorage.removeItem("keepLoggedIn"),await A(t,l)){if(!v){const i=localStorage.getItem("refreshToken");i&&(sessionStorage.setItem("refreshToken",i),localStorage.removeItem("refreshToken"))}}else g("Incorrect username or password")},X=async c=>{var a;const n=sessionStorage.getItem("token");if(!n){console.error("No token found, user is not authenticated.");return}const i={userId:c,type:"login"};try{await w.post("https://knowvara.com/api/api/actions/log",i,{headers:{Authorization:`Bearer ${n}`}}),console.log("Login action logged successfully")}catch(u){w.isAxiosError(u)?console.error("Error logging login action:",((a=u.response)==null?void 0:a.data)||u.message):console.error("Error logging login action:",u)}},Z=()=>{console.log("Navigating back to login view"),E("login")},ee={hidden:{opacity:0,y:-150},visible:{opacity:1,y:0},exit:{opacity:0,y:-150}},te={hidden:{opacity:0,y:100},visible:{opacity:1,y:0},exit:{opacity:0,y:100}};return x?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx("div",{className:"",children:"Loading..."})}):e.jsxs("div",{className:"flex items-center justify-center min-h-screen p-8 bg-gray-100",children:[e.jsx(ue,{mode:"wait",onExitComplete:()=>{z&&h("/student")},children:L==="signup"?e.jsx(j.div,{variants:te,initial:"hidden",animate:"visible",exit:"exit",transition:{duration:.5},className:"",style:{width:"480px"},children:e.jsx(be,{orgId:P,onBackToLogin:Z,orgLogoUrl:R})},"signup"):W?e.jsx(j.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},className:"p-6 bg-red-100 border border-red-400 text-red-700 rounded mb-4 w-full max-w-md",children:e.jsx("p",{children:"The account you are trying to log in to is no longer active."})},"inactive-message"):!z&&e.jsxs(j.div,{variants:ee,initial:"hidden",animate:"visible",exit:"exit",transition:{duration:.5},className:"p-8 md:p-16 bg-white bg-opacity-90 rounded-xl shadow-2xl flex flex-col",style:{width:"480px"},children:[e.jsx("div",{className:"flex flex-col items-center mb-10",children:e.jsx("div",{className:"text-xl font-boldtext-gray-700",children:e.jsx("img",{src:R?"/content"+R:"/defaultOrgLogo.png",alt:"Company Logo",className:"max-h-24 w-auto object-contain p-1"})})}),e.jsxs("form",{onSubmit:Q,className:"w-full",children:[e.jsxs("div",{className:"relative mb-8",children:[e.jsx(j.input,{type:"email",id:"email",value:t,onChange:c=>r(c.target.value),className:"block px-3 py-2 w-full text-gray-700 dark:text-gray-300 bg-transparent border-b-2 border-gray-300 dark:border-gray-600 appearance-none focus:outline-none focus:ring-0 focus:border-blue-500 peer valid:border-blue-500",placeholder:" ",required:!0,"aria-describedby":"email-error",initial:!1,animate:{borderColor:d?"#f56565":"#d1d5db"},transition:{duration:.3}}),e.jsx("label",{htmlFor:"email",className:`absolute left-3 top-2.5 text-gray-500 dark:text-gray-400 text-sm transition-all \r
               peer-placeholder-shown:top-2.5\r
               peer-placeholder-shown:text-base \r
               peer-focus:-top-4 peer-focus:text-sm\r
               peer-valid:-top-4 peer-valid:text-sm`,children:"Email"})]}),e.jsxs("div",{className:"relative mb-12",children:[e.jsx(j.input,{type:"password",id:"password",value:l,onChange:c=>p(c.target.value),className:"block px-3 py-2 w-full text-gray-700 dark:text-gray-300 bg-transparent border-b-2 border-gray-300 dark:border-gray-600 appearance-none focus:outline-none focus:ring-0 focus:border-blue-500 peer valid:border-blue-500",placeholder:" ",required:!0,"aria-describedby":"password-error",animate:{borderColor:d?"#f56565":"#d1d5db"},transition:{duration:.3}}),e.jsx("label",{htmlFor:"password",className:`absolute left-3 top-2.5 text-gray-500 dark:text-gray-400 text-sm transition-all \r
               peer-placeholder-shown:top-2.5 peer-placeholder-shown:text-base \r
               peer-focus:-top-4 peer-focus:text-sm \r
               peer-valid:-top-4 peer-valid:text-sm`,children:"Password"})]}),d&&e.jsx("p",{id:"password-error",className:"text-red-500 text-xs italic mb-4",style:{marginTop:"-20px"},children:d}),e.jsx("div",{className:"mb-4",children:e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",checked:v,onChange:c=>F(c.target.checked),className:"mr-2"}),e.jsx("span",{className:"text-gray-600",children:"Keep me logged in"})]})}),e.jsx("div",{className:"flex items-center justify-end mb-2",children:e.jsx(j.button,{whileHover:{scale:1.1,backgroundColor:"#6366F1"},whileTap:{scale:.95},className:"lms-button px-4 py-2 text-xs bg-blue-500 text-white rounded transition-colors duration-300",type:"submit",children:"Sign In"})})]}),I&&e.jsx("div",{className:"text-center mt-4",children:e.jsx("button",{onClick:()=>E("signup"),className:"text-blue-500 hover:text-blue-700 text-sm underline",children:"New User? Sign up here"})})]},"login")}),_&&e.jsxs(me,{title:"Free Trial Expired",onClose:()=>O(!1),onConfirm:()=>{O(!1),h("/pick-plan")},confirmText:"Upgrade Plan",children:[e.jsx("p",{children:"Your free trial has expired, but there's great news. KnowVara offers the most affordable LMS plans available."}),e.jsx("p",{children:'Click "Upgrade Plan" to continue using KnowVara.'})]})]})};export{we as default};
