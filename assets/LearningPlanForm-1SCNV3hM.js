import{c as R,v as q,d as M,r as c,B as i,j as e,f as I,an as B,aq as F}from"./index-BEzWJCG4.js";import{D as z,H as U,u as T,a as _}from"./index-I8ALC52F.js";const P={COURSE:"course"},H=({course:o,index:n,moveCourse:d,removeCourse:f})=>{const s=B.useRef(null),[,u]=T({accept:P.COURSE,hover(g,x){if(!s.current)return;const b=g.index,v=n;if(b===v)return;const y=s.current.getBoundingClientRect(),N=(y.bottom-y.top)/2,h=x.getClientOffset();if(!h)return;const r=h.y-y.top;b<v&&r<N||b>v&&r>N||(d(b,v),g.index=v)}}),[{isDragging:l},j]=_({type:P.COURSE,item:{type:P.COURSE,index:n},collect:g=>({isDragging:g.isDragging()})});return j(u(s)),e.jsxs("div",{ref:s,className:"flex flex-row items-center relative opacity-100",style:{opacity:l?.5:1},children:[n!==0&&e.jsx("div",{className:"w-4 h-0.5 bg-gray-400 mr-2"}),e.jsxs("div",{className:"learningPlanDrag flex items-center p-4 rounded-sm shadow-lg relative cursor-move",children:[e.jsx("span",{className:"font-medium",children:o.Name}),e.jsx("button",{type:"button",onClick:()=>f(n),className:"absolute top-2 right-2 lms-icon","aria-label":`Remove ${o.Name}`,children:e.jsx(F,{})})]})]})},Y=({addedCourses:o,setAddedCourses:n,removeCourse:d})=>{const f=c.useCallback((s,u)=>{const l=[...o],[j]=l.splice(s,1);l.splice(u,0,j),l.forEach((g,x)=>{g.sequenceOrder=x+1}),n(l)},[o,n]);return e.jsx("div",{className:"flex flex-row flex-wrap gap-2 gap-y-4 mb-6",children:o.map((s,u)=>s.Id===void 0||s.Name===void 0?(console.error("AddedCourse has undefined Id or Name:",s),null):e.jsx(H,{course:s,index:u,moveCourse:f,removeCourse:d},s.Id.toString()))})},Q=()=>{const{user:o}=R(),{id:n}=q(),d=!!n,f=M(),[s,u]=c.useState(null),[l,j]=c.useState(""),[g,x]=c.useState(""),[b,v]=c.useState(""),[y,N]=c.useState([]),[h,r]=c.useState([]),[w,A]=c.useState("");console.log("useParams id:",n),console.log("isEditMode:",d),c.useEffect(()=>{o!=null&&o.OrgID?(console.log("OrgID found:",o.OrgID),u(o.OrgID)):(console.error("Organization ID is missing."),i.error("Organization ID is missing. Please log in again."),f("/login"))},[o,f]),c.useEffect(()=>{console.log("Current orgId:",s)},[s]);const k=async()=>{if(!s)return;const a=sessionStorage.getItem("token");if(!a){i.error("Authentication token is missing. Please log in again.");return}try{const t=await I.get(`https://knowvara.com/api/api/courses/${s}`,{headers:{Authorization:`Bearer ${a}`}});console.log("API Response for available courses:",t.data);const m=t.data;Array.isArray(m)?N(m):(console.error("Unexpected data format:",t.data),N([]),i.error("Failed to fetch courses: Invalid data format."))}catch(t){console.error("Error fetching courses:",t),N([]),i.error("Failed to fetch courses.")}},S=async()=>{if(!d||!n||!s)return;const a=sessionStorage.getItem("token");if(!a){i.error("Authentication token is missing. Please log in again.");return}try{console.log("About to get the details of the learning plan");const t=await I.get(`https://knowvara.com/api/api/learning-plans/${n}`,{headers:{Authorization:`Bearer ${a}`}});console.log("API Response for learning plan:",t.data);const m=t.data;if(j(m.name),x(m.description||""),v(m.objective||""),Array.isArray(m.courses)){const C=m.courses.sort((p,$)=>p.sequence_order-$.sequence_order).map(p=>({Id:p.id,Name:p.name,sequenceOrder:p.sequence_order})).filter(p=>p.Id===void 0||p.Name===void 0?(console.error("Invalid course data:",p),i.error("Invalid course data in Learning Plan."),!1):!0);r(C),console.log("Mapped Added Courses:",C)}else r([]),i.error("Invalid courses data in Learning Plan.")}catch(t){console.error("Error fetching Learning Plan:",t),i.error("Failed to fetch Learning Plan.")}};c.useEffect(()=>{s&&k()},[s]),c.useEffect(()=>{d&&n&&s&&S()},[d,n,s]);const O=async a=>{if(a.preventDefault(),!l.trim()){A("Name is required.");return}if(!s){i.error("Organization ID is missing.");return}const t=sessionStorage.getItem("token");if(!t){i.error("Authentication token is missing. Please log in again.");return}const m={orgId:s,name:l,description:g,objective:b,courses:h.map((C,p)=>({courseId:C.Id,sequenceOrder:p+1}))};try{d&&n?(await I.put(`https://knowvara.com/api/api/learning-plans/${n}`,m,{headers:{Authorization:`Bearer ${t}`}}),i.success("Learning Plan updated successfully.")):(await I.post("https://knowvara.com/api/api/learning-plans",m,{headers:{Authorization:`Bearer ${t}`}}),i.success("Learning Plan created successfully.")),f("/admin/courses")}catch(C){console.error("Error saving Learning Plan:",C),A("Failed to save Learning Plan."),i.error("Failed to save Learning Plan.")}},L=()=>{f("/admin/courses")},D=a=>{if(h.find(t=>t.Id===a.Id)){i.warn("Course already added to the Learning Plan.");return}if(a.Id===void 0||a.Name===void 0){console.error("Invalid course data being added:",a),i.error("Cannot add an invalid course.");return}r([...h,{Id:a.Id,Name:a.Name,sequenceOrder:h.length+1}])},E=a=>{const t=[...h];t.splice(a,1),t.forEach((m,C)=>{m.sequenceOrder=C+1}),r(t)};return e.jsxs(z,{backend:U,children:[e.jsxs("div",{className:"relative pb-16",children:[" ",e.jsxs("div",{className:"flex flex-col md:flex-row h-auto min-h-[100%]",children:[e.jsxs("div",{className:"w-full md:w-3/5 p-6 md:border-r border-gray-300",children:[e.jsx("h2",{className:"text-2xl font-semibold mb-4",children:d?"Edit Learning Plan":"Create Learning Plan"}),e.jsxs("form",{onSubmit:O,id:"learning-plan-form",children:[w&&e.jsx("div",{className:"mb-4 text-red-500",children:w}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"block text-gray-700 mb-2",children:["Name",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:l,onChange:a=>j(a.target.value),className:"w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 text-lg",required:!0})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 mb-2",children:"Objective"}),e.jsx("textarea",{value:b,onChange:a=>v(a.target.value),className:"w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400",rows:3})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 mb-2",children:"Description"}),e.jsx("textarea",{value:g,onChange:a=>x(a.target.value),className:"w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400",rows:3})]}),h.length>0?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"w-full mt-8 mb-6",children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Added Courses"}),e.jsx("p",{className:" mb-4",children:"Drag the courses into the desired order."})]}),e.jsx("div",{className:"flex flex-row flex-wrap gap-4",children:e.jsx(Y,{addedCourses:h,setAddedCourses:r,removeCourse:E})})]}):e.jsxs("div",{className:"w-full mt-8",children:[e.jsx("h3",{className:"text-xl font-semibold mb-4",children:"Added Courses"}),e.jsx("p",{className:" mb-4",children:'Click "Add" next to courses on the right to add them to this Learning Plan.'})]})]})]}),e.jsxs("div",{className:"w-full md:w-2/5 p-6",children:[e.jsx("h3",{className:"text-xl font-semibold mb-4",children:"Available Courses"}),e.jsx(G,{availableCourses:y,onAddCourse:D})]})]})]}),e.jsx("div",{className:"fixed bottom-0 left-0 w-full bg-white p-4 flex justify-end space-x-4 items-center border-t shadow-md",children:e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{type:"button",onClick:L,className:"lms-cancel-button py-2 px-4 text-white mr-2 w-48",children:"Cancel"}),e.jsx("button",{type:"submit",form:"learning-plan-form",className:"lms-button py-2 px-4 text-white w-full sm:w-48",children:d?"Update Learning Plan":"Create Learning Plan"})]})})]})},G=({availableCourses:o=[],onAddCourse:n})=>{const[d,f]=c.useState(""),[s,u]=c.useState(1),[l,j]=c.useState(10);if(!Array.isArray(o))return console.error("availableCourses is not an array:",o),e.jsx("div",{children:"Error: Invalid courses data."});const g=o.filter(r=>r.Name.toLowerCase().includes(d.toLowerCase())),x=Math.ceil(g.length/l),b=s*l,v=b-l,y=g.slice(v,b),N=r=>{f(r.target.value),u(1)},h=r=>{j(parseInt(r.target.value)),u(1)};return e.jsxs("div",{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-center mb-4 space-y-2 sm:space-y-0",children:[e.jsx("input",{type:"text",placeholder:"Search courses...",value:d,onChange:N,className:"w-full sm:w-1/2 px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm"}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"mr-2 text-gray-700 text-sm",children:"Show:"}),e.jsxs("select",{value:l,onChange:h,className:"px-2 py-1 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm",children:[e.jsx("option",{value:10,children:"10"}),e.jsx("option",{value:25,children:"25"}),e.jsx("option",{value:50,children:"50"})]})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full bg-white",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"py-2 px-4 border-b border-gray-200 text-left",children:"Course Name"}),e.jsx("th",{className:"w-32 py-2 px-4 border-b border-gray-200 text-center"})]})}),e.jsx("tbody",{children:y.length>0?y.map(r=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"py-2 px-4 border-b border-gray-200",children:r.Name}),e.jsx("td",{className:"py-2 px-4 border-b border-gray-200 text-center",children:e.jsx("button",{type:"button",onClick:()=>n(r),className:"px-3 py-1 lms-button","aria-label":`Add ${r.Name}`,children:"+ Add"})})]},r.Id)):e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"py-2 px-4 border-b border-gray-200 text-center",children:"No courses found."})})})]})}),x>1&&e.jsxs("div",{className:"flex justify-center items-center mt-4 space-x-2",children:[e.jsx("button",{onClick:()=>u(r=>Math.max(r-1,1)),disabled:s===1,className:`px-2 py-1 text-sm border rounded-md text-sm ${s===1?"bg-gray-200 cursor-not-allowed":"bg-white hover:bg-gray-100"}`,children:"Previous"}),Array.from({length:x},(r,w)=>w+1).map(r=>e.jsx("button",{onClick:()=>u(r),className:`px-2 py-1 text-sm border rounded-md text-sm ${s===r?"bg-blue-500 text-white":"bg-white hover:bg-gray-100"}`,children:r},r)),e.jsx("button",{onClick:()=>u(r=>Math.min(r+1,x)),disabled:s===x,className:`px-2 py-1 text-sm border rounded-md text-sm ${s===x?"bg-gray-200 cursor-not-allowed":"bg-white hover:bg-gray-100"}`,children:"Next"})]})]})};export{Q as default};
